---
// filepath: src/pages/configurator/index.astro
import Layout from "../../layouts/Layout.astro";
import ProgressBar from "../../components/configurator/ProgressBar.astro";
import GlassesViewer from "../../components/configurator/GlassesViewer.astro";
import ConfigPanel from "../../components/configurator/ConfigPanel.astro";
import BranchesConfigPanel from "../../components/configurator/BranchesConfigPanel.astro";
import VerresConfigPanel from "../../components/configurator/VerresConfigPanel.astro";
import DimensionsConfigPanel from "../../components/configurator/DimensionsConfigPanel.astro";
import ActionsConfigPanel from "../../components/configurator/ActionsConfigPanel.astro";
import AIAssistant from "../../components/configurator/AIAssistant.astro";
---

<Layout title="Configurateur TaVue - Composer ma paire">
  <main class="h-[calc(100vh-60px)] bg-white flex">
    <div class="w-2/3 flex flex-col">
      
      <!-- Barre de progression -->
      <ProgressBar currentStep={1} />

      <!-- Section : Aper√ßu du mod√®le 3D -->
      <GlassesViewer frameColor="#000000" />
    </div>

    <!-- Panneaux de configuration -->
    <div id="config-container" class="w-1/3 h-full">
      <!-- √âtape 1 : Forme & Mat√©riau -->
      <div id="step-1" class="config-step active w-full h-full">
        <ConfigPanel price="249‚Ç¨" />
      </div>
      
      <!-- √âtape 2 : Branches -->
      <div id="step-2" class="config-step hidden w-full h-full">
        <BranchesConfigPanel price="249‚Ç¨" />
      </div>
      
      <!-- √âtape 3 : Verres -->
      <div id="step-3" class="config-step hidden w-full h-full">
        <VerresConfigPanel price="249‚Ç¨" />
      </div>
      
      <!-- √âtape 4 : Dimensions -->
      <div id="step-4" class="config-step hidden w-full h-full">
        <DimensionsConfigPanel price="249‚Ç¨" />
      </div>
      
      <!-- √âtape 5 : Actions -->
      <div id="step-5" class="config-step hidden w-full h-full">
        <ActionsConfigPanel price="249‚Ç¨" />
      </div>
    </div>
  </main>

  <!-- Assistant IA -->
  <AIAssistant />
</Layout>

<style>
  .config-step {
    transition: opacity 0.3s ease-in-out;
  }
  
  .config-step.hidden {
    display: none;
  }
  
  .config-step.active {
    display: block;
  }
</style>

<script>
  // G√©rer l'affichage des panneaux selon l'√©tape
  function showPanel(stepNumber: number) {
    const panels = document.querySelectorAll('.config-step');
    
    panels.forEach(panel => {
      const panelId = panel.id;
      const panelStep = parseInt(panelId.replace('step-', ''));
      
      if (panelStep === stepNumber) {
        panel.classList.remove('hidden');
        panel.classList.add('active');
      } else {
        panel.classList.remove('active');
        panel.classList.add('hidden');
      }
    });
  }

  // Syst√®me de gestion global des √©tapes
  class StepManager {
    private currentStep = 1;
    private maxSteps = 5;

    getCurrentStep() {
      return this.currentStep;
    }

    setStep(step: number) {
      if (step >= 1 && step <= this.maxSteps) {
        this.currentStep = step;
        this.updateUI();
        this.notifyChange();
      }
    }

    nextStep() {
      if (this.currentStep < this.maxSteps) {
        this.setStep(this.currentStep + 1);
      }
    }

    prevStep() {
      if (this.currentStep > 1) {
        this.setStep(this.currentStep - 1);
      }
    }

    private updateUI() {
      showPanel(this.currentStep);
    }

    private notifyChange() {
      window.dispatchEvent(new CustomEvent('stepChange', { 
        detail: { currentStep: this.currentStep } 
      }));
    }
  }

  // Instance globale
  const stepManager = new StepManager();

  // Fonction pour afficher les notifications
  function showNotification(message: string, type: 'success' | 'error' | 'info' = 'success') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Cr√©er une notification visuelle simple
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 font-secondary transition-all duration-300 ${
      type === 'success' ? 'bg-green-500 text-white' :
      type === 'error' ? 'bg-red-500 text-white' :
      'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Supprimer apr√®s 4 secondes
    setTimeout(() => {
      notification.style.opacity = '0';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 4000);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // V√©rifier s'il y a un param√®tre d'√©dition dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('edit');

    if (editId) {
      // Charger les donn√©es de la cr√©ation √† modifier
      try {
        const pbModule = await import('../../utils/pb');
        const pb = pbModule.default;
        
        const lunette = await pb.collection('Lunette').getOne(editId);
        console.log('üìù Chargement de la cr√©ation pour modification:', lunette);
        
        // Dispatcher un √©v√©nement avec les donn√©es de la cr√©ation
        window.dispatchEvent(new CustomEvent('loadExistingCreation', {
          detail: lunette
        }));
        
        showNotification(`üîß Modification de "${lunette.nom_modele}"`, 'info');
      } catch (error) {
        console.error('‚ùå Erreur lors du chargement de la cr√©ation:', error);
        showNotification('‚ùå Impossible de charger la cr√©ation √† modifier', 'error');
      }
    }

    // Initialiser avec l'√©tape 1
    showPanel(1);

    // Gestion des boutons de navigation
    document.addEventListener('click', (e: Event) => {
      const target = e.target as HTMLElement;
      
      if (target && (target.id === 'next-step' || target.closest('#next-step'))) {
        e.preventDefault();
        stepManager.nextStep();
      }
      
      if (target && (target.id === 'prev-step' || target.closest('#prev-step'))) {
        e.preventDefault();
        stepManager.prevStep();
      }
    });

    // Exposer le stepManager globalement pour les autres scripts
    (window as any).stepManager = stepManager;

    // Gestion de l'enregistrement des lunettes
    window.addEventListener('saveLunette', async (e: Event) => {
      try {
        const customEvent = e as CustomEvent;
        console.log('√âv√©nement saveLunette re√ßu:', customEvent.detail);

        // Import dynamique des utilitaires PocketBase et Auth
        const [pbModule, authModule] = await Promise.all([
          import('../../utils/pb'),
          import('../../utils/auth')
        ]);
        
        const pb = pbModule.default;
        const { AuthService } = authModule;

        // V√©rifier que l'utilisateur est connect√©
        if (!AuthService.isAuthenticated()) {
          showNotification('‚ùå Vous devez √™tre connect√© pour enregistrer une paire de lunettes', 'error');
          // Redirection vers la page de connexion avec l'URL actuelle
          setTimeout(() => {
            window.location.href = '/auth?redirect=' + encodeURIComponent(window.location.pathname);
          }, 2000);
          return;
        }

        const lunetteConfig = customEvent.detail;

        // D'abord, r√©cup√©rer les mat√©riaux disponibles pour validation
        let materiaux = await pb.collection('Materiau').getFullList();
        console.log('üîç Mat√©riaux disponibles:', materiaux);

        // Si aucun mat√©riau n'existe, cr√©er des mat√©riaux par d√©faut
        if (materiaux.length === 0) {
          console.log('üìù Aucun mat√©riau trouv√©, cr√©ation de mat√©riaux par d√©faut...');
          const materiauxDefaut = [
            { libelle: "Ac√©tate Artisanal" },
            { libelle: "Titane Premium" }, 
            { libelle: "Acier Inoxydable" },
            { libelle: "Corne Naturelle" },
            { libelle: "Plastique Recycl√©" }
          ];

          for (const materiau of materiauxDefaut) {
            try {
              const created = await pb.collection('Materiau').create(materiau);
              console.log('‚úÖ Mat√©riau cr√©√©:', created);
              materiaux.push(created);
            } catch (createError) {
              console.error('‚ùå Erreur cr√©ation mat√©riau:', createError);
            }
          }
        }

        // V√©rifier que le mat√©riau existe et obtenir un ID valide
        let validMaterialId = null;
        
        if (materiaux.length > 0) {
          // Chercher le mat√©riau par ID
          const foundMaterial = materiaux.find((mat: any) => mat.id === lunetteConfig.id_materiau);
          
          if (foundMaterial) {
            validMaterialId = foundMaterial.id;
            console.log('‚úÖ Mat√©riau trouv√©:', foundMaterial);
          } else {
            // Si l'ID n'existe pas, utiliser le premier mat√©riau disponible
            validMaterialId = materiaux[0].id;
            console.log('‚ö†Ô∏è Mat√©riau non trouv√©, utilisation du premier disponible:', materiaux[0]);
          }
        } else {
          throw new Error('Aucun mat√©riau disponible dans la base de donn√©es. V√©rifiez que PocketBase est lanc√© et que la collection Materiau existe.');
        }

        // Pr√©parer les donn√©es pour PocketBase avec validation stricte
        const lunetteData = {
          nom_modele: String(lunetteConfig.nom_modele || 'Ma cr√©ation'),
          date_enregistrement: new Date().toISOString(),
          code_svg: String(lunetteConfig.code_svg || ''),
          largeur_pont: Number(lunetteConfig.largeur_pont) || 18,
          taille_verres: Number(lunetteConfig.taille_verres) || 52,
          couleur_verres: String(lunetteConfig.couleur_verres || 'transparent'),
          couleur_monture: String(lunetteConfig.couleur_monture || '#000000'),
          couleur_branches: String(lunetteConfig.couleur_branches || '#000000'),
          id_utilisateur: String(pb.authStore.record?.id || ''),
          id_materiau: String(validMaterialId || '')
        };

        console.log('üîç Donn√©es √† enregistrer (typ√©es):', lunetteData);
        console.log('üîç Types des donn√©es:');
        console.log('  - nom_modele:', typeof lunetteData.nom_modele, lunetteData.nom_modele);
        console.log('  - largeur_pont:', typeof lunetteData.largeur_pont, lunetteData.largeur_pont);
        console.log('  - taille_verres:', typeof lunetteData.taille_verres, lunetteData.taille_verres);
        console.log('  - id_utilisateur:', typeof lunetteData.id_utilisateur, lunetteData.id_utilisateur);
        console.log('  - id_materiau:', typeof lunetteData.id_materiau, lunetteData.id_materiau);

        // Enregistrer dans PocketBase
        let record;
        try {
          record = await pb.collection('Lunette').create(lunetteData);
          console.log('‚úÖ Lunette enregistr√©e avec succ√®s:', record);
        } catch (createError: any) {
          console.error('‚ùå Erreur d√©taill√©e lors de la cr√©ation:', createError);
          
          // Si c'est une erreur de validation, afficher les d√©tails
          if (createError?.data) {
            console.error('üìã Donn√©es d\'erreur:', createError.data);
          }
          
          throw createError;
        }
        
        // Notification de succ√®s
        const successEvent = new CustomEvent('lunetteCreated', {
          detail: { success: true, record }
        });
        window.dispatchEvent(successEvent);

        // Afficher notification de succ√®s
        showNotification('‚úÖ Paire enregistr√©e avec succ√®s !', 'success');
        
        // Redirection apr√®s un d√©lai
        setTimeout(() => {
          window.location.href = '/panier';
        }, 2000);

      } catch (error) {
        console.error('Erreur lors de l\'enregistrement de la lunette:', error);
        
        // Notification d'erreur
        const errorEvent = new CustomEvent('lunetteCreated', {
          detail: { success: false, error }
        });
        window.dispatchEvent(errorEvent);

        showNotification('‚ùå Erreur lors de l\'enregistrement: ' + (error as any)?.message, 'error');
      }
    });

    // Fonction pour afficher les notifications (r√©utilis√©e)
    function showNotification(message: string, type: 'success' | 'info' | 'error') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-secondary text-sm z-50 transition-opacity duration-300 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'info' ? 'bg-blue-600' : 'bg-red-600'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Exposer la fonction de notification globalement
    (window as any).showNotification = showNotification;

    // =============================================================================
    // SYST√àME D'ASSISTANT IA
    // =============================================================================

    let isAIOpen = false;
    let isAILoading = false;
    let aiMessages: Array<{ type: 'user' | 'assistant'; content: string; timestamp: Date }> = [];

    // Fonctions pour g√©rer l'Assistant IA
    function toggleAI() {
      isAIOpen = !isAIOpen;
      updateAIDisplay();
    }

    function closeAI() {
      isAIOpen = false;
      updateAIDisplay();
    }

    function updateAIDisplay() {
      const aiContainer = document.querySelector('[data-ai-container]');
      if (aiContainer) {
        if (isAIOpen) {
          aiContainer.classList.remove('hidden');
        } else {
          aiContainer.classList.add('hidden');
        }
      }
    }

    async function submitAIMessage(message: string) {
      if (isAILoading) return;

      // Ajouter le message utilisateur
      aiMessages.push({
        type: 'user',
        content: message,
        timestamp: new Date()
      });

      isAILoading = true;
      updateAIMessages();

      try {
        // Appeler l'API AI directement
        const response = await fetch('/api/modifyGlasses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message,
            currentConfig: {
              frameColor: '#1a1a1a',
              templeColor: '#1a1a1a',
              lensColor: '#87CEEB',
              material: 'acetate',
              lensType: 'clear',
              frameWidth: 140,
              templeLength: 140,
              bridgeWidth: 16
            }
          })
        });

        if (!response.ok) {
          throw new Error(`Erreur API: ${response.status}`);
        }

        const result = await response.json();
        
        // Ajouter la r√©ponse de l'IA
        aiMessages.push({
          type: 'assistant',
          content: result.explanation,
          timestamp: new Date()
        });

        // Appliquer la configuration
        if (result.config && Object.keys(result.config).length > 0) {
          window.dispatchEvent(new CustomEvent('aiConfigUpdate', {
            detail: result.config
          }));

          showNotification('ü§ñ Configuration appliqu√©e par l\'IA !', 'success');
        }

      } catch (error) {
        console.error('Erreur IA:', error);
        
        aiMessages.push({
          type: 'assistant',
          content: 'D√©sol√©, je n\'ai pas pu traiter votre demande. Pouvez-vous reformuler ?',
          timestamp: new Date()
        });

        showNotification('‚ùå Erreur de l\'assistant IA', 'error');
      }

      isAILoading = false;
      updateAIMessages();
    }

    function updateAIMessages() {
      // Cette fonction sera appel√©e pour mettre √† jour l'affichage des messages
      // Pour l'instant, on √©met juste un √©v√©nement
      window.dispatchEvent(new CustomEvent('aiMessagesUpdate', {
        detail: {
          messages: aiMessages,
          isLoading: isAILoading
        }
      }));
    }

    // Exposer les fonctions globalement
    (window as any).closeAIAssistant = closeAI;
    (window as any).submitAIMessage = submitAIMessage;
    (window as any).toggleAI = toggleAI;
  });
</script>