---
// filepath: src/pages/configurator/index.astro
import Layout from "../../layouts/Layout.astro";
import ProgressBar from "../../components/configurator/ProgressBar.astro";
import GlassesViewer from "../../components/configurator/GlassesViewer.astro";
import ConfigPanel from "../../components/configurator/ConfigPanel.astro";
import BranchesConfigPanel from "../../components/configurator/BranchesConfigPanel.astro";
import VerresConfigPanel from "../../components/configurator/VerresConfigPanel.astro";
import DimensionsConfigPanel from "../../components/configurator/DimensionsConfigPanel.astro";
import ActionsConfigPanel from "../../components/configurator/ActionsConfigPanel.astro";
import AIAssistant from "../../components/configurator/AIAssistant.astro";
---

<Layout title="Configurateur TaVue - Composer ma paire">
  <main class="h-[calc(100vh-60px)] bg-white flex">
    <div class="w-2/3 flex flex-col">
      
      <!-- Barre de progression -->
      <ProgressBar currentStep={1} />

      <!-- Section : AperÃ§u du modÃ¨le 3D -->
      <GlassesViewer frameColor="#000000" />
    </div>

    <!-- Panneaux de configuration -->
    <div id="config-container" class="w-1/3 h-full">
      <!-- Ã‰tape 1 : Forme & MatÃ©riau -->
      <div id="step-1" class="config-step active w-full h-full">
        <ConfigPanel price="249â‚¬" />
      </div>
      
      <!-- Ã‰tape 2 : Branches -->
      <div id="step-2" class="config-step hidden w-full h-full">
        <BranchesConfigPanel price="249â‚¬" />
      </div>
      
      <!-- Ã‰tape 3 : Verres -->
      <div id="step-3" class="config-step hidden w-full h-full">
        <VerresConfigPanel price="249â‚¬" />
      </div>
      
      <!-- Ã‰tape 4 : Dimensions -->
      <div id="step-4" class="config-step hidden w-full h-full">
        <DimensionsConfigPanel price="249â‚¬" />
      </div>
      
      <!-- Ã‰tape 5 : Actions -->
      <div id="step-5" class="config-step hidden w-full h-full">
        <ActionsConfigPanel price="249â‚¬" />
      </div>
    </div>
  </main>

  <!-- Assistant IA -->
  <AIAssistant />
</Layout>

<style>
  .config-step {
    transition: opacity 0.3s ease-in-out;
  }
  
  .config-step.hidden {
    display: none;
  }
  
  .config-step.active {
    display: block;
  }
</style>

<script>
  // GÃ©rer l'affichage des panneaux selon l'Ã©tape
  function showPanel(stepNumber: number) {
    const panels = document.querySelectorAll('.config-step');
    
    panels.forEach(panel => {
      const panelId = panel.id;
      const panelStep = parseInt(panelId.replace('step-', ''));
      
      if (panelStep === stepNumber) {
        panel.classList.remove('hidden');
        panel.classList.add('active');
      } else {
        panel.classList.remove('active');
        panel.classList.add('hidden');
      }
    });
  }

  // SystÃ¨me de gestion global des Ã©tapes
  class StepManager {
    private currentStep = 1;
    private maxSteps = 5;

    getCurrentStep() {
      return this.currentStep;
    }

    setStep(step: number) {
      if (step >= 1 && step <= this.maxSteps) {
        this.currentStep = step;
        this.updateUI();
        this.notifyChange();
      }
    }

    nextStep() {
      if (this.currentStep < this.maxSteps) {
        this.setStep(this.currentStep + 1);
      }
    }

    prevStep() {
      if (this.currentStep > 1) {
        this.setStep(this.currentStep - 1);
      }
    }

    private updateUI() {
      showPanel(this.currentStep);
    }

    private notifyChange() {
      window.dispatchEvent(new CustomEvent('stepChange', { 
        detail: { currentStep: this.currentStep } 
      }));
    }
  }

  // Instance globale
  const stepManager = new StepManager();

  // Fonction pour afficher les notifications
  function showNotification(message: string, type: 'success' | 'error' | 'info' = 'success') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // CrÃ©er une notification visuelle simple
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 font-secondary transition-all duration-300 ${
      type === 'success' ? 'bg-green-500 text-white' :
      type === 'error' ? 'bg-red-500 text-white' :
      'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Supprimer aprÃ¨s 4 secondes
    setTimeout(() => {
      notification.style.opacity = '0';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 4000);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // VÃ©rifier s'il y a un paramÃ¨tre d'Ã©dition dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('edit');

    if (editId) {
      // Charger les donnÃ©es de la crÃ©ation Ã  modifier
      try {
        const pbModule = await import('../../utils/pb');
        const pb = pbModule.default;
        
        const lunette = await pb.collection('Lunette').getOne(editId);
        console.log('ðŸ“ Chargement de la crÃ©ation pour modification:', lunette);
        
        // Dispatcher un Ã©vÃ©nement avec les donnÃ©es de la crÃ©ation
        window.dispatchEvent(new CustomEvent('loadExistingCreation', {
          detail: lunette
        }));
        
        showNotification(`ðŸ”§ Modification de "${lunette.nom_modele}"`, 'info');
      } catch (error) {
        console.error('âŒ Erreur lors du chargement de la crÃ©ation:', error);
        showNotification('âŒ Impossible de charger la crÃ©ation Ã  modifier', 'error');
      }
    }

    // Initialiser avec l'Ã©tape 1
    showPanel(1);

    // Gestion des boutons de navigation
    document.addEventListener('click', (e: Event) => {
      const target = e.target as HTMLElement;
      
      if (target && (target.id === 'next-step' || target.closest('#next-step'))) {
        e.preventDefault();
        stepManager.nextStep();
      }
      
      if (target && (target.id === 'prev-step' || target.closest('#prev-step'))) {
        e.preventDefault();
        stepManager.prevStep();
      }
    });

    // Exposer le stepManager globalement pour les autres scripts
    (window as any).stepManager = stepManager;

    // Gestion de l'enregistrement des lunettes
    window.addEventListener('saveLunette', async (e: Event) => {
      try {
        const customEvent = e as CustomEvent;
        console.log('Ã‰vÃ©nement saveLunette reÃ§u:', customEvent.detail);

        // Import dynamique des utilitaires PocketBase et Auth
        const [pbModule, authModule] = await Promise.all([
          import('../../utils/pb'),
          import('../../utils/auth')
        ]);
        
        const pb = pbModule.default;
        const { AuthService } = authModule;

        // VÃ©rifier que l'utilisateur est connectÃ©
        if (!AuthService.isAuthenticated()) {
          showNotification('âŒ Vous devez Ãªtre connectÃ© pour enregistrer une paire de lunettes', 'error');
          // Redirection vers la page de connexion avec l'URL actuelle
          setTimeout(() => {
            window.location.href = '/auth?redirect=' + encodeURIComponent(window.location.pathname);
          }, 2000);
          return;
        }

        const lunetteConfig = customEvent.detail;

        // D'abord, rÃ©cupÃ©rer les matÃ©riaux disponibles pour validation
        let materiaux = await pb.collection('Materiau').getFullList();
        console.log('ðŸ” MatÃ©riaux disponibles:', materiaux);

        // Si aucun matÃ©riau n'existe, crÃ©er des matÃ©riaux par dÃ©faut
        if (materiaux.length === 0) {
          console.log('ðŸ“ Aucun matÃ©riau trouvÃ©, crÃ©ation de matÃ©riaux par dÃ©faut...');
          const materiauxDefaut = [
            { libelle: "AcÃ©tate Artisanal" },
            { libelle: "Titane Premium" }, 
            { libelle: "Acier Inoxydable" },
            { libelle: "Corne Naturelle" },
            { libelle: "Plastique RecyclÃ©" }
          ];

          for (const materiau of materiauxDefaut) {
            try {
              const created = await pb.collection('Materiau').create(materiau);
              console.log('âœ… MatÃ©riau crÃ©Ã©:', created);
              materiaux.push(created);
            } catch (createError) {
              console.error('âŒ Erreur crÃ©ation matÃ©riau:', createError);
            }
          }
        }

        // VÃ©rifier que le matÃ©riau existe et obtenir un ID valide
        let validMaterialId = null;
        
        if (materiaux.length > 0) {
          // Chercher le matÃ©riau par ID
          const foundMaterial = materiaux.find((mat: any) => mat.id === lunetteConfig.id_materiau);
          
          if (foundMaterial) {
            validMaterialId = foundMaterial.id;
            console.log('âœ… MatÃ©riau trouvÃ©:', foundMaterial);
          } else {
            // Si l'ID n'existe pas, utiliser le premier matÃ©riau disponible
            validMaterialId = materiaux[0].id;
            console.log('âš ï¸ MatÃ©riau non trouvÃ©, utilisation du premier disponible:', materiaux[0]);
          }
        } else {
          throw new Error('Aucun matÃ©riau disponible dans la base de donnÃ©es. VÃ©rifiez que PocketBase est lancÃ© et que la collection Materiau existe.');
        }

        // PrÃ©parer les donnÃ©es pour PocketBase avec validation stricte
        const lunetteData = {
          nom_modele: String(lunetteConfig.nom_modele || 'Ma crÃ©ation'),
          date_enregistrement: new Date().toISOString(),
          code_svg: String(lunetteConfig.code_svg || ''),
          largeur_pont: Number(lunetteConfig.largeur_pont) || 18,
          taille_verres: Number(lunetteConfig.taille_verres) || 52,
          couleur_verres: String(lunetteConfig.couleur_verres || 'transparent'),
          couleur_monture: String(lunetteConfig.couleur_monture || '#000000'),
          couleur_branches: String(lunetteConfig.couleur_branches || '#000000'),
          id_utilisateur: pb.authStore.record?.id,
          id_materiau: String(validMaterialId || '')
        };

        console.log('ðŸ” DonnÃ©es Ã  enregistrer (typÃ©es):', lunetteData);
        console.log('ðŸ” Types des donnÃ©es:');
        console.log('  - nom_modele:', typeof lunetteData.nom_modele, lunetteData.nom_modele);
        console.log('  - largeur_pont:', typeof lunetteData.largeur_pont, lunetteData.largeur_pont);
        console.log('  - taille_verres:', typeof lunetteData.taille_verres, lunetteData.taille_verres);
        console.log('  - id_materiau:', typeof lunetteData.id_materiau, lunetteData.id_materiau);

        // Enregistrer dans PocketBase
        let record;
        try {
          record = await pb.collection('Lunette').create(lunetteData);
          console.log('âœ… Lunette enregistrÃ©e avec succÃ¨s:', record);
        } catch (createError: any) {
          console.error('âŒ Erreur dÃ©taillÃ©e lors de la crÃ©ation:', createError);
          
          // Si c'est une erreur de validation, afficher les dÃ©tails
          if (createError?.data) {
            console.error('ðŸ“‹ DonnÃ©es d\'erreur:', createError.data);
          }
          
          throw createError;
        }
        
        // Notification de succÃ¨s
        const successEvent = new CustomEvent('lunetteCreated', {
          detail: { success: true, record }
        });
        window.dispatchEvent(successEvent);

        // Afficher notification de succÃ¨s
        showNotification('âœ… Paire enregistrÃ©e avec succÃ¨s !', 'success');
        
        // Redirection aprÃ¨s un dÃ©lai
        setTimeout(() => {
          window.location.href = '/panier';
        }, 2000);

      } catch (error) {
        console.error('Erreur lors de l\'enregistrement de la lunette:', error);
        
        // Notification d'erreur
        const errorEvent = new CustomEvent('lunetteCreated', {
          detail: { success: false, error }
        });
        window.dispatchEvent(errorEvent);

        showNotification('âŒ Erreur lors de l\'enregistrement: ' + (error as any)?.message, 'error');
      }
    });

    // Fonction pour afficher les notifications (rÃ©utilisÃ©e)
    function showNotification(message: string, type: 'success' | 'info' | 'error') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-secondary text-sm z-50 transition-opacity duration-300 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'info' ? 'bg-blue-600' : 'bg-red-600'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Exposer la fonction de notification globalement
    (window as any).showNotification = showNotification;
  });
</script>