---
// filepath: src/components/configurator/ConfigPanel.astro
import Button from "../ui/Button.astro";

export interface Props {
  price?: string;
}

const { price = "249‚Ç¨" } = Astro.props;
---

<!-- Section droite : Configuration Forme & Mat√©riau (1/3) -->
<div class="bg-white flex flex-col h-full border-l border-gray-100">
  
  <!-- Contenu scrollable -->
  <div class="flex-1 overflow-y-auto p-6">
    
    <!-- Header de la section -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="font-secondary text-xl font-medium text-gray-900 mb-1">Configuration</h2>
        <p class="font-secondary text-sm text-gray-500">Personnalisez votre monture</p>
      </div>
      <div class="bg-gray-50 px-3 py-2 rounded-lg">
        <span class="text-gray-900 font-secondary font-semibold text-lg">{price}</span>
      </div>
    </div>

    <!-- Section Mat√©riau -->
    <div class="mb-8">
      <h3 class="font-secondary font-medium text-gray-900 mb-4">Mat√©riau</h3>
      
      <div class="grid grid-cols-3 gap-3">
        <!-- Plastique (s√©lectionn√©) -->
        <button class="material-btn group flex flex-col items-center p-4 rounded-xl bg-gray-50 border-2 border-gray-900 text-gray-900 font-secondary transition-all duration-200 hover:bg-gray-100" data-material-id="1" data-material-name="Plastique">
          <div class="w-8 h-8 mb-2 flex items-center justify-center">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <circle cx="8" cy="8" r="1" fill="currentColor"/>
              <circle cx="16" cy="8" r="1" fill="currentColor"/>
            </svg>
          </div>
          <span class="text-sm font-medium">Plastique</span>
          <span class="text-xs text-gray-500 mt-1">L√©ger</span>
        </button>
        
        <!-- M√©tal -->
        <button class="material-btn group flex flex-col items-center p-4 rounded-xl bg-white border border-gray-200 text-gray-600 font-secondary transition-all duration-200 hover:border-gray-300 hover:bg-gray-50" data-material-id="2" data-material-name="M√©tal">
          <div class="w-8 h-8 mb-2 flex items-center justify-center">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="4" y="4" width="16" height="16" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <line x1="8" y1="8" x2="16" y2="8" stroke="currentColor" stroke-width="1"/>
              <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="1"/>
            </svg>
          </div>
          <span class="text-sm font-medium">M√©tal</span>
          <span class="text-xs text-gray-500 mt-1">Solide</span>
        </button>
        
        <!-- Bois -->
        <button class="material-btn group flex flex-col items-center p-4 rounded-xl bg-white border border-gray-200 text-gray-600 font-secondary transition-all duration-200 hover:border-gray-300 hover:bg-gray-50" data-material-id="3" data-material-name="Bois">
          <div class="w-8 h-8 mb-2 flex items-center justify-center">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <path d="m6 6 12 12M6 18l12-12" stroke="currentColor" stroke-width="0.5" opacity="0.5"/>
            </svg>
          </div>
          <span class="text-sm font-medium">Bois</span>
          <span class="text-xs text-gray-500 mt-1">Naturel</span>
        </button>
      </div>
    </div>

    <!-- Section Couleur -->
    <div class="mb-8">
      <h3 class="font-secondary font-medium text-gray-900 mb-4">Couleur</h3>
      
      <div class="grid grid-cols-4 gap-3 mb-4">
        <!-- Palette harmonieuse moderne -->
        <button 
          data-color="#2563eb" 
          class="color-btn w-10 h-10 bg-blue-600 rounded-lg border-3 border-blue-600 shadow-sm transition-all hover:scale-105 hover:shadow-md"
          title="Bleu oc√©an"
        ></button>
        <button 
          data-color="#7c3aed" 
          class="color-btn w-10 h-10 bg-violet-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-violet-600"
          title="Violet moderne"
        ></button>
        <button 
          data-color="#059669" 
          class="color-btn w-10 h-10 bg-emerald-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-emerald-600"
          title="Vert √©meraude"
        ></button>
        <button 
          data-color="#dc2626" 
          class="color-btn w-10 h-10 bg-red-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-red-600"
          title="Rouge cerise"
        ></button>
        <button 
          data-color="#ea580c" 
          class="color-btn w-10 h-10 bg-orange-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-orange-600"
          title="Orange mandarine"
        ></button>
        <button 
          data-color="#0891b2" 
          class="color-btn w-10 h-10 bg-cyan-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-cyan-600"
          title="Cyan tropical"
        ></button>
        <button 
          data-color="#4338ca" 
          class="color-btn w-10 h-10 bg-indigo-700 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-indigo-700"
          title="Indigo profond"
        ></button>
        <button 
          data-color="#374151" 
          class="color-btn w-10 h-10 bg-gray-700 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-gray-700"
          title="Gris anthracite"
        ></button>
      </div>

      <!-- S√©lecteur de couleur personnalis√©e -->
      <div class="flex items-center gap-3 pt-3 border-t border-gray-100">
        <button 
          id="custom-color-btn"
          class="flex items-center justify-center w-10 h-10 bg-linear-to-br from-purple-400 to-pink-400 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-gray-400"
          title="Couleur personnalis√©e"
        >
          <svg class="w-5 h-5 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <input 
          type="color" 
          id="custom-color-picker" 
          class="hidden"
          value="#2563eb"
        />
        <span class="text-sm text-gray-500 font-secondary">Couleur personnalis√©e</span>
      </div>
    </div>

  </div>

  <!-- Boutons de navigation (toujours visibles) -->
  <div class="bg-white border-t border-gray-100 p-6">
    <div class="flex justify-between items-center">
      <button id="prev-step" class="flex items-center gap-2 text-gray-400 font-secondary text-sm transition-colors hover:text-gray-600 opacity-50 cursor-not-allowed">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Pr√©c√©dent
      </button>
      
      <button id="next-step" class="flex h-10 px-6 items-center rounded-lg bg-gray-900 text-white font-secondary font-medium transition-all duration-200 hover:bg-gray-800 hover:shadow-md">
        Suivant
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

</div>

<script>
  // Gestion du changement de mat√©riau et couleur de la monture
  document.addEventListener('DOMContentLoaded', () => {
    const colorButtons = document.querySelectorAll('.color-btn');
    const materialButtons = document.querySelectorAll('.material-btn');
    
    // Gestion des mat√©riaux
    materialButtons.forEach(button => {
      button.addEventListener('click', () => {
        const materialId = button.getAttribute('data-material-id');
        const materialName = button.getAttribute('data-material-name');
        
        // Mise √† jour de l'interface
        materialButtons.forEach(btn => {
          btn.classList.remove('bg-gray-50', 'border-gray-900', 'text-gray-900');
          btn.classList.add('bg-white', 'border-gray-200', 'text-gray-600');
        });
        
        button.classList.remove('bg-white', 'border-gray-200', 'text-gray-600');
        button.classList.add('bg-gray-50', 'border-gray-900', 'text-gray-900');
        
        // Dispatch d'un √©v√©nement personnalis√©
        window.dispatchEvent(new CustomEvent('materialChange', { 
          detail: { materialId: materialId, materialName: materialName } 
        }));
      });
    });
    
    // Gestion des couleurs
    colorButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedColor = button.getAttribute('data-color');
        
        // Mise √† jour de l'interface
        colorButtons.forEach(btn => {
          const htmlBtn = btn as HTMLElement;
          htmlBtn.classList.remove('border-3');
          htmlBtn.classList.add('border-2', 'border-gray-200');
          htmlBtn.style.borderColor = '';
        });
        
        const htmlButton = button as HTMLElement;
        htmlButton.classList.remove('border-2', 'border-gray-200');
        htmlButton.classList.add('border-3');
        if (selectedColor) {
          htmlButton.style.borderColor = selectedColor;
        }
        
        // Mise √† jour de la couleur du SVG
        document.documentElement.style.setProperty('--frame-color', selectedColor);
        
        // Dispatch d'un √©v√©nement personnalis√© pour d'autres composants
        window.dispatchEvent(new CustomEvent('frameColorChange', { 
          detail: { color: selectedColor } 
        }));
      });
    });

    // Gestion du s√©lecteur de couleur personnalis√©e
    const customColorBtn = document.getElementById('custom-color-btn');
    const customColorPicker = document.getElementById('custom-color-picker') as HTMLInputElement;

    customColorBtn?.addEventListener('click', () => {
      customColorPicker.click();
    });

    customColorPicker?.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const selectedColor = target.value;
      
      // D√©s√©lectionner toutes les couleurs pr√©d√©finies
      colorButtons.forEach(btn => {
        const htmlBtn = btn as HTMLElement;
        htmlBtn.classList.remove('border-3');
        htmlBtn.classList.add('border-2', 'border-gray-200');
        htmlBtn.style.borderColor = '';
      });

      // Mettre √† jour le bouton personnalis√©
      if (customColorBtn) {
        customColorBtn.style.background = selectedColor;
        customColorBtn.classList.remove('border-2', 'border-gray-200');
        customColorBtn.classList.add('border-3');
        customColorBtn.style.borderColor = selectedColor;
      }

      // Mise √† jour de la couleur du SVG
      document.documentElement.style.setProperty('--frame-color', selectedColor);
      
      // Dispatch d'un √©v√©nement personnalis√©
      window.dispatchEvent(new CustomEvent('frameColorChange', { 
        detail: { color: selectedColor, custom: true } 
      }));
    });

    // √âcouter l'√©v√©nement de chargement d'une cr√©ation existante
    window.addEventListener('loadExistingCreation', (e) => {
      const customEvent = e as CustomEvent;
      const lunette = customEvent.detail;
      console.log('üìù ConfigPanel: Chargement de la cr√©ation existante:', lunette);

      // Charger la couleur de la monture
      if (lunette.couleur_monture) {
        const colorButton = document.querySelector(`[data-color="${lunette.couleur_monture}"]`) as HTMLElement;
        if (colorButton) {
          colorButton.click(); // Simuler un clic pour activer la couleur
        }
      }

      // Charger le mat√©riau si disponible
      if (lunette.expand?.id_materiau?.libelle) {
        const materialButton = document.querySelector(`[data-material-name="${lunette.expand.id_materiau.libelle}"]`) as HTMLElement;
        if (materialButton) {
          materialButton.click(); // Simuler un clic pour activer le mat√©riau
        }
      }
    });
  });
</script>