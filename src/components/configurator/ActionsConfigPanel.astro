---
// filepath: src/components/configurator/ActionsConfigPanel.astro
import Button from "../ui/Button.astro";

export interface Props {
  price?: string;
}

const { price = "249‚Ç¨" } = Astro.props;
---

<!-- Section droite : Actions Finales (5/5) -->
<div class="bg-gray-50 flex flex-col h-full">
  
  <!-- Contenu scrollable -->
  <div class="flex-1 overflow-y-auto p-4">
    
    <!-- Header de la section -->
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="font-primary text-lg text-[#003366] mb-1">Votre Mod√®le Personnalis√©</h2>
        <p class="font-secondary text-gray-600 text-xs">Fabrication Fran√ßaise</p>
      </div>
      <div class="text-[#003366] font-secondary font-bold text-base">
        {price}
      </div>
    </div>

    <!-- Barre de s√©paration -->
    <div class="h-px bg-gray-200 mb-4"></div>

    <!-- Section Nom du Mod√®le -->
    <div class="mb-4">
      <h3 class="font-secondary font-semibold text-[#003366] mb-3">Nom du Mod√®le</h3>
      <input 
        type="text" 
        id="model-name"
        placeholder="Nommer votre cr√©ation..."
        class="w-full h-12 px-4 rounded-[14px] border-2 border-gray-200 bg-white font-secondary text-gray-700 focus:border-[#003366] focus:outline-none transition-colors duration-300"
        maxlength="30"
      />
      <p class="text-xs text-gray-500 mt-1 font-secondary">Maximum 30 caract√®res</p>
    </div>

    <!-- R√©sum√© de la Configuration -->
    <div class="mb-4">
      <h3 class="font-secondary font-semibold text-[#003366] mb-3">R√©sum√© de Votre Configuration</h3>
      <div class="bg-white rounded-lg border border-gray-200 p-4 space-y-3">
        
        <!-- Mat√©riau -->
        <div class="flex justify-between items-center">
          <span class="font-secondary text-sm text-gray-600">Mat√©riau</span>
          <span class="font-secondary text-sm font-medium" id="summary-material">Ac√©tate Artisanal</span>
        </div>
        
        <!-- Couleur Monture -->
        <div class="flex justify-between items-center">
          <span class="font-secondary text-sm text-gray-600">Couleur Monture</span>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full border border-gray-300" id="summary-frame-color" style="background-color: #000000;"></div>
            <span class="font-secondary text-sm font-medium" id="summary-frame-color-name">Noir</span>
          </div>
        </div>
        
        <!-- Couleur Branches -->
        <div class="flex justify-between items-center">
          <span class="font-secondary text-sm text-gray-600">Couleur Branches</span>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full border border-gray-300" id="summary-branch-color" style="background-color: #000000;"></div>
            <span class="font-secondary text-sm font-medium" id="summary-branch-color-name">Noir</span>
          </div>
        </div>
        
        <!-- Dimensions -->
        <div class="flex justify-between items-center">
          <span class="font-secondary text-sm text-gray-600">Dimensions</span>
          <span class="font-secondary text-sm font-medium" id="summary-dimensions">Largeur: 52mm, Pont: 18mm</span>
        </div>
      </div>
    </div>





  </div>

  <!-- Boutons de navigation et prix (toujours visibles) -->
  <div class="bg-gray-50 border-t border-gray-200 p-4">
    <div class="flex justify-between items-center">
      <!-- Bouton Pr√©c√©dent -->
      <button id="prev-step" class="flex items-center gap-2 text-[#003366] font-secondary transition-colors hover:text-[#830000]">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Pr√©c√©dent
      </button>
      
      <!-- Prix final au centre -->
      <div class="text-center">
        <p class="font-secondary text-xs text-gray-600">Prix final</p>
        <p class="font-secondary text-lg font-bold text-[#003366]" id="final-price">{price}</p>
      </div>
      
      <!-- Bouton Ajouter au panier -->
      <button id="add-to-cart" class="flex h-10 px-3 items-center shrink-0 self-stretch rounded-[14px] border-none cursor-pointer transition-colors duration-300 text-white font-medium font-secondary bg-[#003366] hover:bg-[#830000]">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"/>
        </svg>
        Ajouter au panier
      </button>
    </div>
  </div>

</div>

<script>
  // Gestion des actions finales
  document.addEventListener('DOMContentLoaded', () => {
    const addToCartBtn = document.querySelector('#add-to-cart');
    const modelNameInput = document.querySelector('#model-name') as HTMLInputElement;
    const finalPriceElement = document.querySelector('#final-price');

    // √âl√©ments du r√©sum√©
    const summaryMaterial = document.querySelector('#summary-material');
    const summaryFrameColor = document.querySelector('#summary-frame-color') as HTMLElement;
    const summaryFrameColorName = document.querySelector('#summary-frame-color-name');
    const summaryBranchColor = document.querySelector('#summary-branch-color') as HTMLElement;
    const summaryBranchColorName = document.querySelector('#summary-branch-color-name');
    const summaryDimensions = document.querySelector('#summary-dimensions');

    // Donn√©es de configuration (mises √† jour en temps r√©el)
    let configurationData = {
      nom_modele: '',
      id_materiau: 1,
      materiau_nom: 'Ac√©tate Artisanal',
      couleur_monture: '#000000',
      couleur_monture_nom: 'Noir',
      couleur_branches: '#000000',
      couleur_branches_nom: 'Noir',
      couleur_verres: 'transparent',
      largeur_pont: 18,
      taille_verres: 52,
      price: 249
    };

    // Fonction pour mettre √† jour le r√©sum√© de configuration
    function updateConfigurationSummary() {
      if (summaryMaterial) {
        summaryMaterial.textContent = configurationData.materiau_nom;
      }
      
      if (summaryFrameColor && summaryFrameColorName) {
        summaryFrameColor.style.backgroundColor = configurationData.couleur_monture;
        summaryFrameColorName.textContent = configurationData.couleur_monture_nom;
      }
      
      if (summaryBranchColor && summaryBranchColorName) {
        summaryBranchColor.style.backgroundColor = configurationData.couleur_branches;
        summaryBranchColorName.textContent = configurationData.couleur_branches_nom;
      }
      
      if (summaryDimensions) {
        summaryDimensions.textContent = `Largeur: ${configurationData.taille_verres}mm, Pont: ${configurationData.largeur_pont}mm`;
      }
    }

    // √âcouter les √©v√©nements de changement de couleur de la monture
    window.addEventListener('frameColorChange', (e) => {
      const event = e as CustomEvent;
      const color = event.detail.color;
      
      configurationData.couleur_monture = color;
      
      // Mapping des couleurs vers les noms
      const colorNames = {
        '#000000': 'Noir',
        '#b45309': 'Marron',
        '#003366': 'Bleu marine',
        '#830000': 'Rouge bordeaux',
        '#15803d': 'Vert'
      };
      
      configurationData.couleur_monture_nom = colorNames[color as keyof typeof colorNames] || 'Couleur personnalis√©e';
      updateConfigurationSummary();
    });

    // √âcouter les √©v√©nements de changement de couleur des branches
    window.addEventListener('branchColorChange', (e) => {
      const event = e as CustomEvent;
      const color = event.detail.color;
      
      configurationData.couleur_branches = color;
      
      const colorNames = {
        '#000000': 'Noir',
        '#b45309': 'Marron',
        '#003366': 'Bleu marine',
        '#830000': 'Rouge bordeaux',
        '#15803d': 'Vert',
        '#9333ea': 'Violet'
      };
      
      configurationData.couleur_branches_nom = colorNames[color as keyof typeof colorNames] || 'Couleur personnalis√©e';
      updateConfigurationSummary();
    });

    // √âcouter les √©v√©nements de changement de mat√©riau
    window.addEventListener('materialChange', (e) => {
      const event = e as CustomEvent;
      const { materialId, materialName } = event.detail;
      
      configurationData.id_materiau = materialId;
      configurationData.materiau_nom = materialName;
      updateConfigurationSummary();
    });

    // √âcouter les √©v√©nements de changement de couleur des verres
    window.addEventListener('lensColorChange', (e) => {
      const event = e as CustomEvent;
      const { color, fill, opacity } = event.detail;
      
      // Mapping des couleurs de verres
      const lensColorNames = {
        'transparent': 'transparent',
        'gray': '#6b7280',
        'dark-gray': '#374151',
        'brown': '#92400e',
        'green': '#166534',
        'blue': '#1e40af',
        'yellow': '#eab308',
        'pink': '#ec4899'
      };
      
      // Stocker la couleur des verres
      configurationData.couleur_verres = lensColorNames[color as keyof typeof lensColorNames] || 'transparent';
      console.log('Couleur des verres mise √† jour:', configurationData.couleur_verres);
    });

    // √âcouter les √©v√©nements de changement de dimensions
    window.addEventListener('dimensionChange', (e) => {
      const event = e as CustomEvent;
      const { type, value } = event.detail;
      
      if (type === 'lens-width') {
        configurationData.taille_verres = value;
      } else if (type === 'bridge-width') {
        configurationData.largeur_pont = value;
      }
      
      updateConfigurationSummary();
    });

    // Initialiser le r√©sum√© au chargement
    updateConfigurationSummary();

    // Fonction pour calculer le prix final (prix fixe pour le moment)
    function updateFinalPrice() {
      if (finalPriceElement) {
        finalPriceElement.textContent = `${configurationData.price}‚Ç¨`;
      }
    }

    // Bouton Ajouter au panier
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', async () => {
        try {
          const modelName = modelNameInput?.value || 'Ma cr√©ation';

          // G√©n√©rer le SVG personnalis√© avec les couleurs directement int√©gr√©es
          const couleurMonture = configurationData.couleur_monture;
          const couleurBranches = configurationData.couleur_branches;
          const couleurVerres = configurationData.couleur_verres;
          
          console.log('üé® G√©n√©ration SVG avec couleurs - Monture:', couleurMonture, 'Branches:', couleurBranches, 'Verres:', couleurVerres);
          
          // Cr√©er un SVG personnalis√© avec les vraies couleurs
          const svgCode = `<svg width="300" height="150" viewBox="0 120 600 200" xmlns="http://www.w3.org/2000/svg">
            <g id="branches">
              <path fill="${couleurBranches}" stroke="${couleurBranches}" stroke-miterlimit="10" stroke-width="0.5" d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"/>
              <path fill="#706f6f" d="M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z"/>
              <path fill="${couleurBranches}" stroke="${couleurBranches}" stroke-miterlimit="10" stroke-width="0.5" d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"/>
              <path fill="#706f6f" d="M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z"/>
              <path fill="#706f6f" d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z"/>
            </g>
            <g id="monture">
              <path fill="${couleurMonture}" stroke="${couleurMonture}" stroke-miterlimit="10" stroke-width="0.5" d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54Z"/>
            </g>
            <g id="verres">
              <path fill="${couleurVerres}" stroke="#d1d5db" stroke-width="1" d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"/>
              <path fill="${couleurVerres}" stroke="#d1d5db" stroke-width="1" d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"/>
            </g>
          </svg>`;

          // Pr√©parer les donn√©es pour PocketBase
          const lunetteConfig = {
            nom_modele: modelName,
            couleur_verres: configurationData.couleur_verres,
            couleur_monture: configurationData.couleur_monture,
            couleur_branches: configurationData.couleur_branches,
            largeur_pont: configurationData.largeur_pont,
            taille_verres: configurationData.taille_verres,
            id_materiau: configurationData.id_materiau.toString(),
            code_svg: svgCode
          };

          // Afficher un indicateur de chargement
          const button = addToCartBtn as HTMLButtonElement;
          button.textContent = 'Enregistrement...';
          button.disabled = true;

          console.log('üìã Configuration compl√®te √† enregistrer:', lunetteConfig);
          console.log('üìã √âtat complet configurationData:', configurationData);

          // Envoyer les donn√©es via un √©v√©nement personnalis√©
          const saveEvent = new CustomEvent('saveLunette', {
            detail: lunetteConfig
          });
          window.dispatchEvent(saveEvent);
          
          // Afficher une confirmation de succ√®s
          showNotification('‚úÖ Configuration pr√©par√©e pour l\'enregistrement !', 'success');

        } catch (error: any) {
          console.error('Erreur lors de la pr√©paration:', error);
          const errorMessage = error?.message || 'Erreur inconnue';
          showNotification('‚ùå Erreur lors de la pr√©paration: ' + errorMessage, 'error');
        } finally {
          // Restaurer le bouton
          const button = addToCartBtn as HTMLButtonElement;
          if (button) {
            button.textContent = 'Ajouter au panier';
            button.disabled = false;
          }
        }
      });
    }





    // Fonction pour afficher les notifications
    function showNotification(message: string, type: 'success' | 'info' | 'error') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white font-secondary text-sm z-50 transition-opacity duration-300 ${
        type === 'success' ? 'bg-green-600' : 
        type === 'info' ? 'bg-blue-600' : 'bg-red-600'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Initialiser le prix
    updateFinalPrice();

    // √âcouter l'√©v√©nement de chargement d'une cr√©ation existante
    window.addEventListener('loadExistingCreation', (e) => {
      const customEvent = e as CustomEvent;
      const lunette = customEvent.detail;
      console.log('üìù ActionsConfigPanel: Chargement de la cr√©ation existante:', lunette);

      // Charger le nom du mod√®le
      if (lunette.nom_modele) {
        const modelNameInput = document.querySelector('#model-name') as HTMLInputElement;
        if (modelNameInput) {
          modelNameInput.value = lunette.nom_modele;
          
          // Dispatcher l'√©v√©nement de changement de nom
          window.dispatchEvent(new CustomEvent('modelNameChange', {
            detail: { name: lunette.nom_modele }
          }));
        }
      }

      // Mettre √† jour le r√©capitulatif avec toutes les donn√©es
      updateConfigurationSummary();
      showNotification('üìù Configuration charg√©e pour modification', 'info');
    });
  });
</script>