---
// filepath: src/components/configurator/VerresConfigPanel.astro
import Button from "../ui/Button.astro";

export interface Props {
  price?: string;
}

const { price = "249‚Ç¨" } = Astro.props;
---

<!-- Section droite : Configuration Verres (3/5) -->
<div class="bg-white flex flex-col h-full border-l border-gray-100">
  <!-- Contenu scrollable -->
  <div class="flex-1 overflow-y-auto p-6">
    <!-- Header de la section -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="font-secondary text-xl font-medium text-gray-900 mb-1">Verres</h2>
        <p class="font-secondary text-sm text-gray-500">Teinte des verres</p>
      </div>
      <div class="bg-gray-50 px-3 py-2 rounded-lg">
        <span class="text-gray-900 font-secondary font-semibold text-lg">{price}</span>
      </div>
    </div>

    <!-- Section Teinte -->
    <div class="mb-8">
      <h3 class="font-secondary font-medium text-gray-900 mb-4">Teinte</h3>
      
      <div class="grid grid-cols-3 gap-4 mb-6">
        <!-- Verres transparents (s√©lectionn√©s) -->
        <button
          data-lens-color="transparent"
          data-lens-fill="#ffffff"
          data-lens-opacity="1"
          class="lens-color-btn group flex flex-col items-center p-4 rounded-xl bg-gray-50 border-2 border-gray-900 transition-all duration-200 hover:bg-gray-100"
          title="Transparent"
        >
          <div class="w-12 h-12 mb-3 flex items-center justify-center">
            <div class="w-8 h-8 bg-white border-2 border-gray-300 rounded-full shadow-sm"></div>
          </div>
          <span class="text-sm font-medium text-gray-900">Transparent</span>
        </button>

        <!-- Verres gris -->
        <button
          data-lens-color="gray"
          data-lens-fill="#6b7280"
          data-lens-opacity="0.7"
          class="lens-color-btn group flex flex-col items-center p-4 rounded-xl bg-white border border-gray-200 transition-all duration-200 hover:border-gray-300 hover:bg-gray-50"
          title="Gris l√©ger"
        >
          <div class="w-12 h-12 mb-3 flex items-center justify-center">
            <div class="w-8 h-8 bg-gray-500 rounded-full shadow-sm"></div>
          </div>
          <span class="text-sm font-medium text-gray-600">Gris l√©ger</span>
        </button>

        <!-- Verres gris fonc√© -->
        <button
          data-lens-color="dark-gray"
          data-lens-fill="#374151"
          data-lens-opacity="0.8"
          class="lens-color-btn group flex flex-col items-center p-4 rounded-xl bg-white border border-gray-200 transition-all duration-200 hover:border-gray-300 hover:bg-gray-50"
          title="Gris fonc√©"
        >
          <div class="w-12 h-12 mb-3 flex items-center justify-center">
            <div class="w-8 h-8 bg-gray-700 rounded-full shadow-sm"></div>
          </div>
          <span class="text-sm font-medium text-gray-600">Gris fonc√©</span>
        </button>

        <!-- Verres bruns -->
        <button
          data-lens-color="brown"
          data-lens-fill="#92400e"
          data-lens-opacity="0.7"
          class="lens-color-btn group flex flex-col items-center p-4 rounded-xl bg-white border border-gray-200 transition-all duration-200 hover:border-gray-300 hover:bg-gray-50"
          title="Brun"
        >
          <div class="w-12 h-12 mb-3 flex items-center justify-center">
            <div class="w-8 h-8 bg-amber-700 rounded-full shadow-sm"></div>
          </div>
          <span class="text-sm font-medium text-gray-600">Brun</span>
        </button>

        <!-- Verres verts -->
        <button
          data-lens-color="green"
          data-lens-fill="#059669"
          data-lens-opacity="0.7"
          class="lens-color-btn group flex flex-col items-center p-4 rounded-xl bg-white border border-gray-200 transition-all duration-200 hover:border-gray-300 hover:bg-gray-50"
          title="Vert"
        >
          <div class="w-12 h-12 mb-3 flex items-center justify-center">
            <div class="w-8 h-8 bg-emerald-600 rounded-full shadow-sm"></div>
          </div>
          <span class="text-sm font-medium text-gray-600">Vert</span>
        </button>

        <!-- Verres bleus -->
        <button
          data-lens-color="blue"
          data-lens-fill="#2563eb"
          data-lens-opacity="0.7"
          class="lens-color-btn group flex flex-col items-center p-4 rounded-xl bg-white border border-gray-200 transition-all duration-200 hover:border-gray-300 hover:bg-gray-50"
          title="Bleu"
        >
          <div class="w-12 h-12 mb-3 flex items-center justify-center">
            <div class="w-8 h-8 bg-blue-600 rounded-full shadow-sm"></div>
          </div>
          <span class="text-sm font-medium text-gray-600">Bleu</span>
        </button>
      </div>

      <!-- √âtat de s√©lection -->
      <div class="bg-gray-50 rounded-lg p-3 text-center">
        <span class="font-secondary text-sm text-gray-600">S√©lection: </span>
        <span class="font-secondary text-sm font-medium text-gray-900" id="transparency-label">Transparent</span>
      </div>
    </div>
  </div>

  <!-- Boutons de navigation (toujours visibles) -->
  <div class="bg-white border-t border-gray-100 p-6">
    <div class="flex justify-between items-center">
      <button id="prev-step" class="flex items-center gap-2 text-gray-600 font-secondary text-sm transition-colors hover:text-gray-900">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Pr√©c√©dent
      </button>
      
      <button id="next-step" class="flex h-10 px-6 items-center rounded-lg bg-gray-900 text-white font-secondary font-medium transition-all duration-200 hover:bg-gray-800 hover:shadow-md">
        Suivant
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // Gestion du changement de teinte des verres
  document.addEventListener("DOMContentLoaded", () => {
    const lensColorButtons = document.querySelectorAll(".lens-color-btn");
    const transparencyLabel = document.querySelector("#transparency-label");

    // Initialiser les verres transparents par d√©faut
    document.documentElement.style.setProperty("--lens-color", "#ffffff");
    document.documentElement.style.setProperty("--lens-opacity", "1");

    lensColorButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const selectedColor = button.getAttribute("data-lens-color");
        const lensFill = button.getAttribute("data-lens-fill");
        const lensOpacity = button.getAttribute("data-lens-opacity");

        // Mise √† jour de l'interface
        lensColorButtons.forEach((btn) => {
          btn.classList.remove("bg-gray-50", "border-gray-900", "text-gray-900");
          btn.classList.add("bg-white", "border-gray-200", "text-gray-600");
        });

        button.classList.remove("bg-white", "border-gray-200", "text-gray-600");
        button.classList.add("bg-gray-50", "border-gray-900", "text-gray-900");

        // Mise √† jour des variables CSS pour les verres
        document.documentElement.style.setProperty("--lens-color", lensFill);
        document.documentElement.style.setProperty(
          "--lens-opacity",
          lensOpacity
        );

        // Mise √† jour du label
        const labelMap = {
          transparent: "Transparent",
          gray: "Gris l√©ger",
          "dark-gray": "Gris fonc√©",
          brown: "Brun",
          green: "Vert",
          blue: "Bleu",
          yellow: "Jaune",
          pink: "Rose",
        };

        if (transparencyLabel && selectedColor) {
          transparencyLabel.textContent =
            labelMap[selectedColor as keyof typeof labelMap] || "Transparent";
        }

        // Dispatch d'un √©v√©nement personnalis√©
        window.dispatchEvent(
          new CustomEvent("lensColorChange", {
            detail: {
              color: selectedColor,
              fill: lensFill,
              opacity: lensOpacity,
            },
          })
        );
      });
    });

    // √âcouter l'√©v√©nement de chargement d'une cr√©ation existante
    window.addEventListener('loadExistingCreation', (e) => {
      const customEvent = e as CustomEvent;
      const lunette = customEvent.detail;
      console.log('üìù VerresConfigPanel: Chargement de la cr√©ation existante:', lunette);

      // Charger la couleur des verres
      if (lunette.couleur_verres) {
        // Essayer de trouver le bouton correspondant par la couleur hex
        const colorButton = document.querySelector(`[data-lens-fill="${lunette.couleur_verres}"]`) as HTMLElement;
        if (colorButton) {
          colorButton.click(); // Simuler un clic pour activer la couleur
        } else if (lunette.couleur_verres === 'transparent') {
          // Activer la transparence
          const transparentButton = document.querySelector(`[data-lens-color="transparent"]`) as HTMLElement;
          if (transparentButton) {
            transparentButton.click();
          }
        }
      }
    });
  });
</script>
