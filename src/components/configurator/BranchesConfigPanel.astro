---
// filepath: src/components/configurator/BranchesConfigPanel.astro
import Button from "../ui/Button.astro";

export interface Props {
  price?: string;
}

const { price = "249‚Ç¨" } = Astro.props;
---

<!-- Section droite : Configuration Branches (2/5) -->
<div class="bg-white flex flex-col h-full border-l border-gray-100">
  <!-- Contenu scrollable -->
  <div class="flex-1 overflow-y-auto p-6">
    <!-- Header de la section -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="font-secondary text-xl font-medium text-gray-900 mb-1">Branches</h2>
        <p class="font-secondary text-sm text-gray-500">Couleur des branches</p>
      </div>
      <div class="bg-gray-50 px-3 py-2 rounded-lg">
        <span class="text-gray-900 font-secondary font-semibold text-lg">{price}</span>
      </div>
    </div>

    <!-- Section Couleur -->
    <div class="mb-8">
      <h3 class="font-secondary font-medium text-gray-900 mb-4">Couleur</h3>
      
      <div class="grid grid-cols-4 gap-3 mb-4">
        <!-- Palette harmonieuse moderne -->
        <button 
          data-branch-color="#2563eb" 
          class="branch-color-btn w-10 h-10 bg-blue-600 rounded-lg border-3 border-blue-600 shadow-sm transition-all hover:scale-105 hover:shadow-md"
          title="Bleu oc√©an"
        ></button>
        <button 
          data-branch-color="#7c3aed" 
          class="branch-color-btn w-10 h-10 bg-violet-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-violet-600"
          title="Violet moderne"
        ></button>
        <button 
          data-branch-color="#059669" 
          class="branch-color-btn w-10 h-10 bg-emerald-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-emerald-600"
          title="Vert √©meraude"
        ></button>
        <button 
          data-branch-color="#dc2626" 
          class="branch-color-btn w-10 h-10 bg-red-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-red-600"
          title="Rouge cerise"
        ></button>
        <button 
          data-branch-color="#ea580c" 
          class="branch-color-btn w-10 h-10 bg-orange-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-orange-600"
          title="Orange mandarine"
        ></button>
        <button 
          data-branch-color="#0891b2" 
          class="branch-color-btn w-10 h-10 bg-cyan-600 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-cyan-600"
          title="Cyan tropical"
        ></button>
        <button 
          data-branch-color="#4338ca" 
          class="branch-color-btn w-10 h-10 bg-indigo-700 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-indigo-700"
          title="Indigo profond"
        ></button>
        <button 
          data-branch-color="#374151" 
          class="branch-color-btn w-10 h-10 bg-gray-700 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-gray-700"
          title="Gris anthracite"
        ></button>
      </div>

      <!-- S√©lecteur de couleur personnalis√©e -->
      <div class="flex items-center gap-3 pt-3 border-t border-gray-100">
        <button 
          id="custom-branch-color-btn"
          class="flex items-center justify-center w-10 h-10 bg-linear-to-br from-purple-400 to-pink-400 rounded-lg border-2 border-gray-200 shadow-sm transition-all hover:scale-105 hover:shadow-md hover:border-gray-400"
          title="Couleur personnalis√©e"
        >
          <svg class="w-5 h-5 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <input 
          type="color" 
          id="custom-branch-color-picker" 
          class="hidden"
          value="#2563eb"
        />
        <span class="text-sm text-gray-500 font-secondary">Couleur personnalis√©e</span>
      </div>
    </div>
  </div>

  <!-- Boutons de navigation (toujours visibles) -->
  <div class="bg-white border-t border-gray-100 p-6">
    <div class="flex justify-between items-center">
      <button id="prev-step" class="flex items-center gap-2 text-gray-600 font-secondary text-sm transition-colors hover:text-gray-900">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Pr√©c√©dent
      </button>
      
      <button id="next-step" class="flex h-10 px-6 items-center rounded-lg bg-gray-900 text-white font-secondary font-medium transition-all duration-200 hover:bg-gray-800 hover:shadow-md">
        Suivant
        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // Gestion du changement de couleur des branches
  document.addEventListener("DOMContentLoaded", () => {
    const branchColorButtons = document.querySelectorAll(".branch-color-btn");

    // Initialiser la couleur par d√©faut (noir)
    document.documentElement.style.setProperty("--branch-color", "#000000");

    branchColorButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const selectedColor = button.getAttribute("data-branch-color");

        // Mise √† jour de l'interface
        branchColorButtons.forEach((btn) => {
          const htmlBtn = btn as HTMLElement;
          htmlBtn.classList.remove("border-3");
          htmlBtn.classList.add("border-2", "border-gray-200");
          htmlBtn.style.borderColor = '';
        });

        const htmlButton = button as HTMLElement;
        htmlButton.classList.remove("border-2", "border-gray-200");
        htmlButton.classList.add("border-3");
        if (selectedColor) {
          htmlButton.style.borderColor = selectedColor;
        }

        // Mise √† jour de la couleur des branches du SVG
        document.documentElement.style.setProperty(
          "--branch-color",
          selectedColor
        );

        // Dispatch d'un √©v√©nement personnalis√©
        window.dispatchEvent(
          new CustomEvent("branchColorChange", {
            detail: { color: selectedColor },
          })
        );
      });
    });

    // Gestion du s√©lecteur de couleur personnalis√©e
    const customBranchColorBtn = document.getElementById('custom-branch-color-btn');
    const customBranchColorPicker = document.getElementById('custom-branch-color-picker') as HTMLInputElement;

    customBranchColorBtn?.addEventListener('click', () => {
      customBranchColorPicker.click();
    });

    customBranchColorPicker?.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const selectedColor = target.value;
      
      // D√©s√©lectionner toutes les couleurs pr√©d√©finies
      branchColorButtons.forEach(btn => {
        const htmlBtn = btn as HTMLElement;
        htmlBtn.classList.remove('border-3');
        htmlBtn.classList.add('border-2', 'border-gray-200');
        htmlBtn.style.borderColor = '';
      });

      // Mettre √† jour le bouton personnalis√©
      if (customBranchColorBtn) {
        customBranchColorBtn.style.background = selectedColor;
        customBranchColorBtn.classList.remove('border-2', 'border-gray-200');
        customBranchColorBtn.classList.add('border-3');
        customBranchColorBtn.style.borderColor = selectedColor;
      }

      // Mise √† jour de la couleur du SVG
      document.documentElement.style.setProperty('--branch-color', selectedColor);
      
      // Dispatch d'un √©v√©nement personnalis√©
      window.dispatchEvent(new CustomEvent('branchColorChange', { 
        detail: { color: selectedColor, custom: true } 
      }));
    });

    // √âcouter l'√©v√©nement de chargement d'une cr√©ation existante
    window.addEventListener('loadExistingCreation', (e) => {
      const customEvent = e as CustomEvent;
      const lunette = customEvent.detail;
      console.log('üìù BranchesConfigPanel: Chargement de la cr√©ation existante:', lunette);

      // Charger la couleur des branches
      if (lunette.couleur_branches) {
        const colorButton = document.querySelector(`[data-branch-color="${lunette.couleur_branches}"]`) as HTMLElement;
        if (colorButton) {
          colorButton.click(); // Simuler un clic pour activer la couleur
        }
      }
    });
  });
</script>
